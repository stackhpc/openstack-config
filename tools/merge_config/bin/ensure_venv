#####
# This script creates a virtualenv (if not already in one) and installs the required dependencies
#####

CONFIG_ROOT="$(dirname $(dirname $(dirname $(dirname $(realpath ${BASH_SOURCE[0]:-${(%):-%x}})))))"

if [[ "$VIRTUAL_ENV" == "" ]]; then
  # Check python version
  # NOTE: Python 3.8 or newer is required for ansible 2.12 
  # which is in turn required for the 'undef' ansible keyword
  PY_MAJOR=3
  PY_MINOR=8
  version_check() {
    python3 <<EOF
import sys
if sys.version_info[0] < $PY_MAJOR or sys.version_info[1] < $PY_MINOR:
    sys.exit(1)
EOF
  }

  if ! version_check; then
    echo "Minimum required python version is $PY_MAJOR.$PY_MINOR" 1>&2
    echo "Please install a supported version then try again" 1>&2
    exit 1
  fi

  VENV="$CONFIG_ROOT/tools/merge_config/.venv"
  if [ ! -d "$VENV" ]; then
    echo "Creating virtual environment at $VENV"
    python3 -m venv "$VENV"
fi

else
VENV=$VIRTUAL_ENV
fi 

echo "Upgrading pip"
"$VENV/bin/python" -m pip install -U pip

echo "Installing requirements"
"$VENV/bin/python" -m pip install -r "$CONFIG_ROOT/requirements.txt"
"$VENV/bin/python" -m pip install -r "$CONFIG_ROOT/tools/merge_config/requirements.txt"